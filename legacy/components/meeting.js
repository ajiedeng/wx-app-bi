"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,i){function n(r,o){try{var s=t[r](o),a=s.value}catch(e){return void i(e)}if(!s.done)return Promise.resolve(a).then(function(e){n("next",e)},function(e){n("throw",e)});e(a)}return n("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_toast=require("./../mixins/toast.js"),_toast2=_interopRequireDefault(_toast),_slot=require("./../utils/slot.js"),_update=require("./../utils/update.js"),_http=require("./../utils/http.js"),_utils=require("./../utils/utils.js"),_utils2=_interopRequireDefault(_utils),meeting=function(e){function t(){var e,i,n,r;_classCallCheck(this,t);for(var o=arguments.length,s=Array(o),a=0;a<o;a++)s[a]=arguments[a];return i=n=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(s))),n.config={},n.mixins=[_toast2.default],n.events={parternersEmit:function(e){this.updatePicker(e,this.curoldEntity)},meetingroomEmit:function(e){this.updatePicker(e,this.curoldEntity)}},n.props={item:{type:Object,default:{},twoWay:!0},index:{type:Number,default:0}},n.data={reserveOptions:[{value:!0,label:"是"},{value:!1,label:"否"}],popupVisible:!1,visible:!1,simple:0,itemHeight:88,visibleItemCount:8,slotId:"",occupiedSlots:{},expiredSlots:{},selectedSlots:{},columns:(0,_slot.generatePeriod)(),children:[],curoldEntity:{},meetingData:{isreserved:"0",isreservedname:"",meetingroom:"",meetingroomname:"",mtstartdate:_utils2.default.formatDateday(),mtenddate:"",mtdate:"",mttime:"",starttime:null,endtime:null,meetingdate:null,deputyorganizer:"",deputyorganizername:"",note:"",relateusers:[],relatelabels:"",iscanfind:""}},n.watch={popupVisible:function(e,t){var i=this;if(!1===t&&!0===e){var n=void 0;if(this.selectedSlots&&Object.keys(this.selectedSlots).length>0)n=Object.keys(this.selectedSlots).sort()[0];else{var r=this.item.value.meetingdate?new Date(1e3*this.item.value.meetingdate):new Date;n=(0,_slot.getSlotIdByDate)(r)}setTimeout(function(){i.visible=!0,i.slotId=n,i.$apply()},0)}},item:function(e,t){this.curoldEntity=Object.assign({},t.value);var i=e.value,n=i.mtdate,r=i.meetingroom,o=t.value,s=o.mtdate,a=o.meetingroom;(n!==s&&r||r!==a&&n)&&(e.value.mttime="",e.value.starttime=null,e.value.endtime=null,this.updatePicker(e.value,t.value))}},n.methods={dateChange:function(e){this.item.value.mtdate=e.detail.value,this.item.value.meetingdate=_utils2.default.valueToStamp(e.detail.value)},enumChange:function(e){this.item.value.isreserved=e.detail.value,this.item.value.isreservedname="0"===e.detail.value?"是":"否"},nameBlur:function(e){this.item.value.name=e.detail.value},noteBlur:function(e){this.item.value.note=e.detail.value},noop:function(){},toSelectParterners:function(){this.$emit("toSelectParterners",this.index)},toSelectRoom:function(){this.$emit("toSelectRoom",this.index)},popupMeetingShow:function(){if(!this.item.value.mtdate||!this.item.value.meetingroom)return this.taskCreatTip("请先选择会议室和会议日期");this.popupVisible=!0,this.item.value.did&&this.updatePicker(this.item.value,this.curoldEntity),this.$apply()},popupCancel:function(){this.popupHidden()},periodCancel:function(){this.popupHidden()},periodConfirm:function(){var e=Object.keys(this.selectedSlots);if(0===e.length)return this.taskCreatTip("请选择时间");var t=_update.updateTimePeriod.call(this,e),i=t.startTime,n=t.endTime;this.item.value.starttime=i,this.item.value.endtime=n;var r=this.columns[e[0]],o=this.columns[e[e.length-1]];this.item.value.mttime=(0,_slot.generateTime)(r,o),this.popupHidden()},itemClicked:function(e){var t=e.currentTarget.dataset.slot,i=parseInt(t),n=this.data,r=n.occupiedSlots,o=void 0===r?{}:r,s=n.expiredSlots,a=void 0===s?{}:s,u=n.selectedSlots,l=void 0===u?{}:u;if(!o[i]&&!a[i]){var c=Object.keys(l||{}).map(function(e){return parseInt(e)}).sort(),p=void 0,d=void 0;c.length>0&&(p=c[0],d=c[c.length-1]),null==p||null==d?p=d=i:i<p?p=i:i>d?d=i:d-i<i-p?d=i-1:p=i+1;for(var m=p;m<=d;m++)if(o[m]||a[m])return this.taskCreatTip("必须选择连续的时间");this.selectedSlots=(0,_slot.rangeToMap)(p,d),this.$apply()}}},r=i,_possibleConstructorReturn(n,r)}return _inherits(t,e),_createClass(t,[{key:"popupHidden",value:function(){var e=this;this.visible=!1,setTimeout(function(){e.popupVisible=!1,e.$apply()},200)}},{key:"updatePicker",value:function(){function e(e,i){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t,i){var n,r,o,s,a,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t||{},r=n.meetingdate,o=n.meetingroom,(0,_update.compareFields)(t,i,"meetingdate","meetingroom")||!r||!o){e.next=10;break}return i&&i.meetingroom&&i.meetingdate&&_update.updateTimePeriod.call(this,[]),e.next=5,(0,_http.queryMeetingList)({meetingdate:t.meetingdate,meetingroom:t.meetingroom});case 5:s=e.sent,a=s.list,u=a?a.map(function(e){return e.slotid}):[],this.occupiedSlots=u.reduce(function(e,i){return((0,_slot.getSlotsID)(t.starttime,t.endtime)||{})[i]||(e[i]=!0),e},{}),this.expiredSlots=(0,_slot.expiredSlots)(r);case 10:(0,_update.compareFields)(t,i,"starttime","endtime")||(this.selectedSlots=(0,_slot.getSlotsID)(t.starttime,t.endtime)),this.$apply();case 12:case"end":return e.stop()}},e,this)}));return e}()},{key:"onLoad",value:function(){this.curoldEntity=Object.assign(this.meetingData,{meetingdate:null,meetingroom:""})}}]),t}(_wepy2.default.component);exports.default=meeting;