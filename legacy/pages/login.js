"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){function r(o,i){try{var a=t[o](i),s=a.value}catch(e){return void n(e)}if(!a.done)return Promise.resolve(s).then(function(e){r("next",e)},function(e){r("throw",e)});e(s)}return r("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_topBar=require("./../components/topBar.js"),_topBar2=_interopRequireDefault(_topBar),_toast=require("./../mixins/toast.js"),_toast2=_interopRequireDefault(_toast),_http=require("./../utils/http.js"),_wxApi=require("./../utils/wxApi.js"),_wxApi2=_interopRequireDefault(_wxApi),_encryption=require("./../utils/encryption.js"),Login=function(e){function t(){var e,n,r,o;_classCallCheck(this,t);for(var i=arguments.length,a=Array(i),s=0;s<i;s++)a[s]=arguments[s];return n=r=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(a))),r.config={navigationBarTitleText:"",navigationBarTextStyle:"black"},r.data={username:"",password:"",version:"",isBackShow:!1},r.mixins=[_toast2.default],r.methods={toLogin:function(){var e=this,t=this;if(0===this.username.trim().length)return this.noAccount();if(0===this.password.trim().length)return this.noPassWord();var n=this.username.indexOf("@")>=0?"email":"phone";wx.login({success:function(){function t(e){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function t(r){var o,i,a,s,u,l,p,c,f;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return o=r.code,i=_defineProperty({password:(0,_encryption.hex_sha1)(e.password+"4969fj#k23#"),js_code:o},n,e.username),a={timestamp:Date.parse(new Date)/1e3,token:(0,_encryption.hex_md5)(JSON.stringify(i)+"xgx3d*fe3478$ukx")},t.prev=3,t.next=6,(0,_http.login)(i,a);case 6:if(!(s=t.sent)||0!==s.status){t.next=26;break}return u={userid:s.userid,loginsession:s.loginsession,nickname:s.nickname,role:s.role,phone:"",email:""},e.$parent.globalData.userInfo=u,e.$parent.globalData.isLogin=!0,t.next=13,(0,_http.queryByUserId)({userid:s.userid});case 13:return l=t.sent,s&&0===s.status&&(p=l.userinfo.accountinfo,u.phone=p.phone,u.email=p.email),c=+new Date+26784e5,e.$parent.globalData.expiredTime=c,e.$apply(),t.next=20,_wepy2.default.setStorageSync("userInfo",JSON.stringify(u));case 20:return t.next=22,_wepy2.default.setStorageSync("EXPIREDTIME",c);case 22:f=e.getCurrentPages().length,f<2?_wepy2.default.redirectTo({url:"/pages/index"}):_wepy2.default.navigateBack({delta:f-1}),t.next=27;break;case 26:_wxApi2.default.logMethod("log","login = "+JSON.stringify(s),!1);case 27:t.next=32;break;case 29:t.prev=29,t.t0=t.catch(3),_wxApi2.default.logMethod("log","login = "+JSON.stringify(t.t0),!1);case 32:case"end":return t.stop()}},t,e,[[3,29]])}));return t}(),fail:function(){t.WXFailLogin()}})},bindBlur:function(e){"username"===e.target.id?this.username=e.detail.value:this.password=e.detail.value}},r.components={topLogin:_topBar2.default},o=n,_possibleConstructorReturn(r,o)}return _inherits(t,e),_createClass(t,[{key:"onShareAppMessage",value:function(){return{title:"BroadLink 智慧办公 - 登录",path:"/pages/login/login"}}},{key:"onLoad",value:function(){}},{key:"onShow",value:function(){this.version=this.$parent.globalData.version}}]),t}(_wepy2.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(Login,"pages/login"));