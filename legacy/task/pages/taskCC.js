"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){function i(a,n){try{var s=t[a](n),o=s.value}catch(e){return void r(e)}if(!s.done)return Promise.resolve(o).then(function(e){i("next",e)},function(e){i("throw",e)});e(o)}return i("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),_wepy=require("./../../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_topBar=require("./../../components/topBar.js"),_topBar2=_interopRequireDefault(_topBar),_skeleton=require("./../../components/skeleton.js"),_skeleton2=_interopRequireDefault(_skeleton),_http=require("./../../utils/http.js"),_utils=require("./../../utils/utils.js"),_utils2=_interopRequireDefault(_utils),_commonApi=require("./../../mixins/commonApi.js"),_commonApi2=_interopRequireDefault(_commonApi),wxApis=require("./../../utils/wxApi.js"),endWords="",isNum,taskCC=function(e){function t(){var e,r,i,a;_classCallCheck(this,t);for(var n=arguments.length,s=Array(n),o=0;o<n;o++)s[o]=arguments[o];return r=i=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(s))),i.$repeat={},i.$props={toptaskCC:{"xmlns:v-on":"",bindparentBackFn:"parentBackFn"},skeleton:{}},i.$events={toptaskCC:{"v-on:topNavFn":"getScrollHeight"}},i.components={toptaskCC:_topBar2.default,skeleton:_skeleton2.default},i.mixins=[_commonApi2.default],i.events={parentBackFn:function(){_wepy2.default.navigateBack()}},i.data={ccList:{},jobId:"",detailJobId:"",preload:{},currentUserid:"",tabsItem:[{isDefault:1,tabName:"所有人"},{isDefault:0,tabName:"部门"}],activeIndex:0,isFocus:!1,chargerArr:[],addCCList:[],addCCGList:[],ccIds:[],chargers:{},chargerlib:{},lineHeight:0,isDefault:!1,selectedCharger:{},top:0,height:0,hidden:!0,endWords:"",showWords:"",trans:"0.1",inputSearch:"",scrollTopId:"",userInfo:{},isAt:!1,atRemark:{},isSkeleton:!0,ccgIds:[],groupList:{},groupLib:{}},i.methods={getScrollHeight:function(e,t){var r=this,i=r.$parent.globalData.windowWH||{},a=i.height;a=a||667;var n=wx.createSelectorQuery();n.select("#topCCSearch").boundingClientRect(),n.exec(function(t){n.select("#tabsCCXScroll").boundingClientRect(),n.exec(function(i){r.height=a-t[0].height-e-i[0].height,r.$apply()}),r.$apply()})},changeTab:function(e,t){this.inputSearch="",this.activeIndex=e,t?_utils2.default.isEmptyObj(this.chargerlib)?this.getAllChargers():this.chargers=this.chargerlib:_utils2.default.isEmptyObj(this.groupLib)?this.getGroupList():this.groupList=this.groupLib,this.$apply()},bindCharger:function(e,t,r){var i=this;e.checked=!e.checked,this.chargers[t][r].checked=e.checked,e.checked?(this.addCCList.push({user_id:e.userid,nickname:e.nickname}),this.ccIds.push(e.userid)):this.addCCList.forEach(function(t,r){t.user_id===e.userid&&(i.addCCList.splice(r,1),i.ccIds.splice(r,1))})},bindGroup:function(e,t,r){var i=this;e.checked=!e.checked,this.groupList[t][r].checked=e.checked,e.checked?(this.addCCGList.push({group_id:e.group_id,group_name:e.group_name}),this.ccgIds.push(e.group_id)):this.addCCGList.forEach(function(t,r){t.group_id===e.group_id&&(i.addCCGList.splice(r,1),i.ccgIds.splice(r,1))})},searchFocus:function(){this.isFocus=!0},searchChange:function(e){""!==e.detail.value.trim()&&(this.inputSearch=e.detail.value.trim(),0===this.activeIndex?this.chargers=this.searchForTab(this.chargerlib,"nickname"):this.groupList=this.searchForTab(this.groupLib,"group_name"))},chStart:function(e){this.trans="0.3",this.hidden=!1,this.top=e.target.offsetTop>10?e.target.offsetTop-3*this.lineHeight/5:3},chEnd:function(e){this.trans="0.1",this.hidden=!0,this.scrollTopId=this.endWords},chMove:function(e){var t=this,r=e.touches[0].clientY,i=0,a=0;wx.createSelectorQuery().select("#charLine").boundingClientRect(function(e){i=e.top;var n=t.chargerArr;if(a=t.lineHeight*n.length+i,r>i&&r<parseInt(a)){var s=parseInt((r-i)/t.lineHeight);endWords=n[s],t.endWords=endWords}isNum!==s&&(isNum=s,t.showWords=t.endWords,t.scrollTopId=t.endWords,t.top=t.lineHeight*s+10-t.lineHeight/3,t.$apply())}).exec()},getWords:function(e){var t=e.target.id;this.endWords=t,isNum=t,this.showWords=this.endWords},setWords:function(e){var t=e.target.id;this.scrollTopId=t},multiDel:function(){this.confirmModify()}},a=r,_possibleConstructorReturn(i,a)}return _inherits(t,e),_createClass(t,[{key:"onShareAppMessage",value:function(){return{title:"BroadLink 智慧办公 - 抄送人",path:"task/pages/taskCC"}}},{key:"getAllChargers",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,(0,_http.queryUserByrole)();case 3:t=e.sent,t&&0===t.status?function(){var e=[],i=t.userlist;for(var a in i)i[a].forEach(function(t){e.push(t)});e=r.handleRepeat(e,"userid"),r.$parent.globalData.allUsers=e,r.ccList=e;var n=r.dealWithUsers(e,{name:"nickname",id:"userid"}),s=n.chargerChild,o=n.chargerArr;r.chargers=s,r.chargerlib=s,r.$parent.globalData.allChargers=s,r.$parent.globalData.chargerArr=o,r.isSkeleton=!1,r.$apply()}():wxApis.logMethod("log","queryUserByrole = "+JSON.stringify(t),_wepy2.default.$instance.globalData.logInfo),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),wxApis.logMethod("log","taskCC = "+JSON.stringify(e.t0),!1);case 10:case"end":return e.stop()}},e,this,[[0,7]])}));return e}()},{key:"confirmModify",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:this.jobId?this.batchAddCC(this.jobId):this.detailJobId?this.batchAddCC(this.detailJobId):this.isAt?(this.$parent.globalData.atIdLists=this.addCCList||[],_wepy2.default.navigateBack()):(this.$parent.globalData.ccInfo=this.addCCList.concat(this.addCCGList),_wepy2.default.navigateBack());case 1:case"end":return e.stop()}},e,this)}));return e}()},{key:"getGroupList",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,i,a,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t={pageid:0,pagesize:9999,group_name:""},e.next=4,(0,_http.queryGroupList)(t);case 4:r=e.sent,r.data&&r.data.length>0&&(i=this.dealWithUsers(r.data,{name:"group_name",id:"group_id"}),a=i.chargerChild,n=i.chargerArr,this.groupList=a,this.groupLib=a,this.groupArr=n,this.$parent.globalData.groupChargers=a,this.$parent.globalData.groupArr=n,this.$apply()),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),wxApis.logMethod("log","queryGroupList = "+JSON.stringify(e.t0),!1);case 11:case"end":return e.stop()}},e,this,[[0,8]])}));return e}()},{key:"batchAddCC",value:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r={ccg:this.ccgIds||[],cc:this.ccIds||[],job_id:t},e.prev=1,e.next=4,(0,_http.batchAddCC)(r);case 4:i=e.sent,i&&0===i.status?_wepy2.default.navigateBack():wxApis.logMethod("log","batchAddCC = "+JSON.stringify(i),_wepy2.default.$instance.globalData.logInfo),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(1),wxApis.logMethod("log","batchAddCC = "+JSON.stringify(e.t0),_wepy2.default.$instance.globalData.logInfo);case 11:case"end":return e.stop()}},e,this,[[1,8]])}));return e}()},{key:"searchForTab",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=(arguments[1],{A:[],B:[],C:[],D:[],E:[],F:[],G:[],H:[],I:[],J:[],K:[],L:[],M:[],N:[],O:[],P:[],Q:[],R:[],S:[],T:[],U:[],V:[],W:[],X:[],Y:[],Z:[],UN:[]});for(var i in t)!function(i){t[i]&&t[i].forEach(function(t){t.name.indexOf(e.inputSearch)>-1&&r[i].push(t)})}(i);for(var i in r)0===r[i].length&&delete r[i];return r}},{key:"onLoad",value:function(e,t){t=t||{},this.preload=t.preload||{}}},{key:"onShow",value:function(){this.isFocus=!1,this.userInfo=this.$parent.globalData.userInfo,this.jobId=this.preload.jobId||this.preload.detailJobId||"",this.isAt=!!this.preload.isAt,this.isAt&&(this.tabsItem=[{isDefault:1,tabName:"所有人"}]),this.addCCList=[],this.ccIds=[],this.currentUserid=this.userInfo.userid;var e=this.$parent.globalData.windowWH||{},t=e.height;t=t||667,this.lineHeight=t<768?(t-100)/27:28,this.winHeight=t-40,this.isChargersIn()}},{key:"isChargersIn",value:function(){var e=this,t=this.$parent.globalData,r=t.allUsers,i=t.allChargers,a=t.chargerArr;if(_utils2.default.isEmptyObj(i))this.getAllChargers();else{for(var n in i)i[n].forEach(function(e){e.checked=!1});this.ccList=r,this.chargers=i,this.chargerlib=i,this.chargerArr=a,setTimeout(function(){e.isSkeleton=!1,e.$apply()},0)}}}]),t}(_wepy2.default.page);Page(require("./../../npm/wepy/lib/wepy.js").default.$createPage(taskCC,"task/pages/taskCC"));