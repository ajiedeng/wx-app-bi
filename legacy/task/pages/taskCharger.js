"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){function a(n,i){try{var s=t[n](i),o=s.value}catch(e){return void r(e)}if(!s.done)return Promise.resolve(o).then(function(e){a("next",e)},function(e){a("throw",e)});e(o)}return a("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),_wepy=require("./../../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_topBar=require("./../../components/topBar.js"),_topBar2=_interopRequireDefault(_topBar),_commonApi=require("./../../mixins/commonApi.js"),_commonApi2=_interopRequireDefault(_commonApi),_http=require("./../../utils/http.js"),_utils=require("./../../utils/utils.js"),_utils2=_interopRequireDefault(_utils),wxApis=require("./../../utils/wxApi.js"),endWords="",isNum,taskCharger=function(e){function t(){var e,r,a,n;_classCallCheck(this,t);for(var i=arguments.length,s=Array(i),o=0;o<i;o++)s[o]=arguments[o];return r=a=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(s))),a.$repeat={},a.$props={toptaskCharger:{"xmlns:v-on":"",bindparentBackFn:"parentBackFn"}},a.$events={toptaskCharger:{"v-on:topNavFn":"getScrollHeight"}},a.components={toptaskCharger:_topBar2.default},a.events={parentBackFn:function(){_wepy2.default.navigateBack()}},a.mixins=[_commonApi2.default],a.data={preload:{},nodeInfo:{},modifyNodeInfo:{},modifiedIndex:"",currentUserid:"",tabsItem:[{isDefault:!0,tabName:"默认人"},{isDefault:!1,tabName:"所有人"}],activeIndex:0,currentEmail:"",currentPhone:"",creatCharger:{},draftCharger:{},chargerArr:[],chargers:{},chargerlib:{},chargerChild:{},isFocus:!1,selectedCharger:{},winHeight:0,height:0,top:0,lineHeight:0,hidden:!0,endWords:"",showWords:"",trans:"0.1",scrollTopId:"",jobId:"",inputSearch:"",chargerInfo:{},userInfo:{},isOnlyAll:!1},a.methods={getScrollHeight:function(e){var t=this,r=t.$parent.globalData.windowWH||{},a=r.height;a=a||667;var n=wx.createSelectorQuery();n.select("#topSearch").boundingClientRect(),n.exec(function(r){n.select("#tabsXScroll").boundingClientRect(),n.exec(function(n){t.height=a-r[0].height-e-n[0].height,t.$apply()})})},changeTab:function(e,t){this.inputSearch="",this.activeIndex=e,1!==this.tabsItem.length&&(t?this.nodeInfo.jobId?this.getNodeInfo():this.creatCharger.itemCharger?(this.chargers=this.chargerInfo.chargerChild,this.chargerlib=this.chargerInfo.chargerChild):this.handleChargers(this.chargerInfo):this.isChargersIn(),this.$apply())},bindCharger:function(e){this.selectedCharger.userid=e.userid,this.selectedCharger.nickname=e.nickname,this.selectedUser=e,this.confirmModify()},searchChange:function(e){var t=this;if(""!==e.detail.value.trim()){this.inputSearch=e.detail.value.trim();var r={A:[],B:[],C:[],D:[],E:[],F:[],G:[],H:[],I:[],J:[],K:[],L:[],M:[],N:[],O:[],P:[],Q:[],R:[],S:[],T:[],U:[],V:[],W:[],X:[],Y:[],Z:[],UN:[]};for(var a in this.chargerlib)!function(a){t.chargerlib[a].forEach(function(t){t.nickname.indexOf(e.detail.value)>-1&&r[a].push(t)})}(a);for(var a in r)0===r[a].length&&delete r[a];this.chargers=r}},searchFocus:function(){this.isFocus=!0},chStart:function(e){this.trans="0.3",this.hidden=!1,this.top=e.target.offsetTop>10?e.target.offsetTop-3*this.lineHeight/5:3},chEnd:function(){this.trans="0.1",this.hidden=!0,this.scrollTopId=this.endWords},chMove:function(e){var t=this,r=e.touches[0].clientY,a=0,n=0;wx.createSelectorQuery().select("#charLine1").boundingClientRect(function(e){a=e.top;var i=t.chargerArr;if(n=t.lineHeight*i.length+a,r>a&&r<parseInt(n)){var s=parseInt((r-a)/t.lineHeight);endWords=i[s],t.endWords=endWords}isNum!==s&&(isNum=s,t.showWords=t.endWords,t.scrollTopId=t.endWords,t.top=t.lineHeight*s+10-t.lineHeight/3,t.$apply())}).exec()},getWords:function(e){var t=e.target.id;this.endWords=t,isNum=t,this.showWords=this.endWords},setWords:function(e){var t=e.target.id;this.scrollTopId=t}},n=r,_possibleConstructorReturn(a,n)}return _inherits(t,e),_createClass(t,[{key:"onShareAppMessage",value:function(){return{title:"BroadLink 智慧办公 - 审核人",path:"task/pages/taskCharger"}}},{key:"getCreateChargers",value:function(e,t){e&&t?(this.isOnlyAll=!1,this.tabsItem=[{isDefault:!1,tabName:"所有人"}],this.isChargersIn()):e||t||(this.tabsItem=[{isDefault:!0,tabName:"默认人"}])}},{key:"getByUserId",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,(0,_http.queryByUserId)({userid:this.currentUserid});case 3:t=e.sent,t&&0===t.status?(this.currentEmail=t.userinfo.accountinfo.email,this.currentPhone=t.userinfo.accountinfo.phone,this.$apply()):wxApis.logMethod("log","queryByUserId = "+JSON.stringify(t),_wepy2.default.$instance.globalData.logInfo),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),wxApis.logMethod("log","queryByUserId = "+JSON.stringify(e.t0),!1);case 10:case"end":return e.stop()}},e,this,[[0,7]])}));return e}()},{key:"getNodeInfo",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,(0,_http.queryNodeInfo)({flowid:this.nodeInfo.jobId,nodeid:this.nodeInfo.nodeId});case 3:t=e.sent,t&&0===t.status&&t.info?(this.handleChargers(t.info),this.$apply()):wxApis.logMethod("log","queryNodeInfo = "+JSON.stringify(t),_wepy2.default.$instance.globalData.logInfo),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),wxApis.logMethod("log","queryNodeInfo = "+JSON.stringify(e.t0),!1);case 10:case"end":return e.stop()}},e,this,[[0,7]])}));return e}()},{key:"handleChargers",value:function(e){var t=this;if(e){e.condidate_user=JSON.parse(e.condidate_user_str||"[]"),e.chargerList=[];if(!e.deuserid&&e.condidate_user&&0===e.condidate_user.length)return this.isOnlyAll=!0,this.tabsItem=[{isDefault:!1,tabName:"所有人"}],this.isChargersIn();if(1!==e.all_user&&(this.tabsItem=[{isDefault:!0,tabName:"默认人"}]),this.modifyNodeInfo=e,e.deuserid&&e.condidate_user.length<=0)e.isDefault=!0,this.handleDefault(e,function(r){r&&t.getUserByTag(e,r,function(e,r){t.handleCharger(e,!0)})});else if(!e.deuserid&&e.condidate_user.length>0){e.isDefault=!1;var r=this.handleCondidate(e);r.length>0&&r.forEach(function(a,n){t.getUserByTag(e,a,function(e,a){n===r.length-1&&setTimeout(function(){t.handleCharger(e,!0)},100)})})}else e.deuserid&&e.condidate_user.length>0&&this.handleBoth(e,function(r){Array.isArray(r)?r.length>0&&r.forEach(function(a,n){t.getUserByTag(e,a,function(e,a){n===r.length-1&&setTimeout(function(){t.handleCharger(e,!0)},100)})}):t.getUserByTag(e,r,function(a,n){e.chargerList.length>0&&(e.charger=e.chargerList[0].userid,e.chargerName=e.chargerList[0].nickname,e.nickname=e.chargerList[0].nickname);var i=t.handleCondidate(e,!0,r);i.length>0&&i.forEach(function(r,a){t.getUserByTag(e,r,function(e,r){a===i.length-1&&setTimeout(function(){t.handleCharger(e,!0)},100)})})})});this.$apply()}}},{key:"getAllChargers",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,(0,_http.queryUserByrole)();case 3:t=e.sent,t&&0===t.status?function(){var e=[],a=t.userlist;for(var n in a)a[n].forEach(function(t){e.push(t)});e=r.handleRepeat(e,"userid"),r.modifyNodeInfo.all_user=1,r.modifyNodeInfo.chargerList=e,r.$parent.globalData.allUsers=e;var i=r.dealWithUsers(e,{name:"nickname",id:"userid"}),s=i.chargerChild,o=i.chargerArr;r.chargers=s,r.chargerlib=s,r.chargerArr=o,r.chargerChild=s,r.$parent.globalData.allChargers=s,r.$parent.globalData.chargerArr=o,r.$apply()}():wxApis.logMethod("log","queryUserByrole = "+JSON.stringify(t),_wepy2.default.$instance.globalData.logInfo),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),wxApis.logMethod("log","taskCC = "+JSON.stringify(e.t0),!1);case 10:case"end":return e.stop()}},e,this,[[0,7]])}));return e}()},{key:"confirmModify",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,a,n,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.nodeInfo.jobId){e.next=14;break}return t={job_id:this.nodeInfo.jobId,node_id:this.nodeInfo.nodeId,node_name:this.nodeInfo.nextName,user_id:this.selectedCharger.userid,role_name:this.selectedCharger.nickname,reason:"",keep_cc:0},e.prev=2,e.next=5,(0,_http.putAssignUser)(t);case 5:r=e.sent,r&&0===r.status?_wepy2.default.navigateBack({delta:1}):wxApis.logMethod("log","putAssignUser = "+JSON.stringify(r),_wepy2.default.$instance.globalData.logInfo),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(2),wxApis.logMethod("log","putAssignUser = "+JSON.stringify(e.t0),!1);case 12:e.next=27;break;case 14:return a=this.selectedUser||"",n={index:this.modifiedIndex,modifiedCharger:a},i={job_id:this.jobId,noder:[{node_id:this.chargerInfo.node_id,node_name:this.chargerInfo.node_name,next_id:this.chargerInfo.next_id,user_id:this.selectedUser.userid,user_name:this.selectedUser.nickname,condidate_user_str:this.chargerInfo.condidate_user_str,deuserid:this.chargerInfo.deuserid}]},this.$parent.globalData.modifiedInfo=n,e.prev=18,e.next=21,(0,_http.setUser)(i);case 21:_wepy2.default.navigateBack(),e.next=27;break;case 24:e.prev=24,e.t1=e.catch(18),wxApis.logMethod("log","setUser = "+JSON.stringify(e.t1),!1);case 27:case"end":return e.stop()}},e,this,[[2,9],[18,24]])}));return e}()},{key:"getUserByTag",value:function(){function e(e,r,a){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r,a){var n,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,_http.queryUserByTag)(r);case 2:n=e.sent,n&&0===n.status?(i=n.list,Array.isArray(i)&&i.length>0?(i=i.filter(function(e){return e.nickname.indexOf("找不到")<0}),t.chargerList||(t.chargerList=[]),t.chargerList=t.chargerList.concat(i),this.handleRepeat(t.chargerList,"userid"),t.chargerList.length>0&&t.isDefault&&(t.charger=t.chargerList[0].userid,t.chargerName=t.chargerList[0].nickname,t.nickname=t.chargerList[0].nickname),a&&a(t,n)):a&&a(t,n)):n&&0!==n.status?(t.chargerList=t.chargerList.concat([]),a&&a(t,n)):wxApis.logMethod("log","queryUserByTag = "+JSON.stringify(n),_wepy2.default.$instance.globalData.logInfo),this.$apply();case 5:case"end":return e.stop()}},e,this)}));return e}()},{key:"onLoad",value:function(e,t){t=t||{},this.userInfo=this.$parent.globalData.userInfo,this.preload=t.preload?t.preload:{},this.currentUserid=this.userInfo.userid,this.initData()}},{key:"onShow",value:function(){}},{key:"isChargersIn",value:function(){var e=this.$parent.globalData,t=e.allChargers,r=e.chargerArr;_utils2.default.isEmptyObj(t)?(1===this.activeIndex?this.isOnlyAll=!1:this.isOnlyAll=!0,this.getAllChargers()):(this.chargers=t,this.chargerlib=t,this.chargerArr=r,this.chargerChild=t)}},{key:"initData",value:function(){this.isOnlyAll=!1,this.isFocus=!1;var e=this.$parent.globalData.windowWH||{},t=e.height;if(t=t||667,this.lineHeight=t<768?(t-100)/27:28,this.winHeight=t-40,this.getByUserId(),this.preload.nodeInfo&&this.preload.nodeInfo.jobId&&(this.nodeInfo=this.preload.nodeInfo,this.getNodeInfo()),this.preload.creatCharger&&(this.preload.creatCharger=this.preload.creatCharger||"{}",this.creatCharger=JSON.parse(this.preload.creatCharger)||{},!_utils2.default.isEmptyObj(this.creatCharger))){this.isAllUser=this.creatCharger.isAllUser,this.modifiedIndex=this.creatCharger.index,this.jobId=this.creatCharger.jobId,this.chargerInfo=this.creatCharger.itemCharger,this.chargerChild=this.chargerInfo.chargerChild,this.chargerlib=this.chargerInfo.chargerlib,this.chargers=this.chargerInfo.chargerChild;var r=_utils2.default.isEmptyObj(this.chargers);this.getCreateChargers(r,this.isAllUser)}this.preload.draftCharger&&(this.draftCharger=this.preload.draftCharger||"{}",this.draftCharger=JSON.parse(this.preload.draftCharger)||{},_utils2.default.isEmptyObj(this.draftCharger)||(this.chargerInfo=this.draftCharger.itemCharger,this.isAllUser=this.draftCharger.isAllUser,this.jobId=this.draftCharger.jobId,this.handleChargers(this.chargerInfo)))}}]),t}(_wepy2.default.page);Page(require("./../../npm/wepy/lib/wepy.js").default.$createPage(taskCharger,"task/pages/taskCharger"));