"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,s){function a(r,i){try{var n=t[r](i),o=n.value}catch(e){return void s(e)}if(!n.done)return Promise.resolve(o).then(function(e){a("next",e)},function(e){a("throw",e)});e(o)}return a("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var a=t[s];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,s,a){return s&&e(t.prototype,s),a&&e(t,a),t}}(),_wepy=require("./../../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_topBar=require("./../../components/topBar.js"),_topBar2=_interopRequireDefault(_topBar),_moduleInfo=require("./../../components/moduleInfo.js"),_moduleInfo2=_interopRequireDefault(_moduleInfo),_toast=require("./../../mixins/toast.js"),_toast2=_interopRequireDefault(_toast),_commonApi=require("./../../mixins/commonApi.js"),_commonApi2=_interopRequireDefault(_commonApi),_utils=require("./../../utils/utils.js"),_utils2=_interopRequireDefault(_utils),_http=require("./../../utils/http.js"),_formatfile=require("./../../utils/formatfile.js"),wxApis=require("./../../utils/wxApi.js"),year,month,day,taskDraft=function(e){function t(){var e,s,a,r;_classCallCheck(this,t);for(var i=arguments.length,n=Array(i),o=0;o<i;o++)n[o]=arguments[o];return s=a=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(n))),a.data={height:0,width:0,preload:{},isBackShow:!0,isShow:!1,isTx:null,index8:0,i:0,issueClass:"",issueSubClass:"",issueClassName:"",issueSubClassName:"",issueName:"",taskNumb:"",assignOP:"",assignPM:"",index:0,txValue:"",ccArray:[],issueSubClassSeleted:!1,isEdited:!1,flag:!1,issueModelInfo:{},jobModule:[],issueGraphList:[],issueClassList:[],issueSubClassList:[],OPList:[],PMList:[],selectedPMList:[],selectedOPList:[],issueClassIndex:0,issueSubClassIndex:0,timeoutIndex:0,userInfo:{},timeout:[24,48],timeoutValue:"",issueInfo:{},totalObj:{},loadUrl:""},a.$repeat={},a.$props={topTaskDraft:{"xmlns:v-on":"","xmlns:v-bind":"","v-bind:isBackShow.sync":"isBackShow",bindparentBackFn:"parentBackFn"},moduleDraft:{"v-bind:jobModule.sync":"jobModule","v-bind:isShow.sync":"isShow","v-bind:isBackShow.sync":"isBackShow","v-bind:txValue.sync":"txValue","v-bind:flag.sync":"flag"}},a.$events={topTaskDraft:{"v-on:topNavFn":"getScrollHeight"},moduleDraft:{"v-on:getFlag":"getFlag","v-on:emitJsNode":"emitJsNode"}},a.components={topTaskDraft:_topBar2.default,moduleDraft:_moduleInfo2.default},a.mixins=[_commonApi2.default,_toast2.default],a.methods={getScrollHeight:function(e,t){var s=this,a=this.$parent.globalData.windowWH||{},r=a.width,i=a.height;i=i||667,s.width=r,s.height=r<768?i-e-54-12:i-e-184-12},taskNameChange:function(e){this.issueName=e.detail.value},timeoutChange:function(e){this.timeoutValue=e.detail.value,this.timeoutIndex=e.detail.value,this.issueModelInfo.time_out=this.timeout[e.detail.value]},textareaBlur:function(e){if(_utils2.default.emojiReg(e.detail.value))return this.taskCreatTip("文本不能包含表情符号");this.$broadcast("textareaBlur",e.detail.value)},textareaChange:function(e){this.$broadcast("textareaChange",e.detail.value)},saveTx:function(){this.isBackShow=!0,this.isShow=!1},previewImage:function(e,t){_wepy2.default.previewImage({current:e,urls:t})},deleteCC:function(){function e(e,s){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t,s){var a,r=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:a=s.user_id?"jobid="+this.jobId+"&userid="+this.issueModelInfo.ccList[t].user_id:"jobid="+this.jobId+"&groupid="+this.issueModelInfo.ccList[t].group_id,this.skip("N",_asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,(0,_http.delCC)({},a);case 3:t=e.sent,t&&0===t.status&&r.getJobInfo(),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),wxApis.logMethod("log","delCC = "+JSON.stringify(e.t0),_wepy2.default.$instance.globalData.logInfo);case 10:case"end":return e.stop()}},e,r,[[0,7]])})));case 2:case"end":return e.stop()}},e,this)}));return e}(),taskCreateDrafted:function(){this.skip("N",function(){_wepy2.default.redirectTo({url:"./taskDraft"})})},taskCreateConfirm:function(){var e=this.$parent.globalData.tabsInfo||{};e.tabs&&(e.tabs.activeIndex=1,e.tabs.status=[],e.tabs.currentTabUrl="list",e.top=0,this.$parent.globalData.tabsInfo=e),this.skip("N_JOB",function(){_wepy2.default.navigateBack()})},ccAdd:function(){this.$preload("jobId",this.jobId),this.setIssueStorage(),this.skip("N",function(){_wepy2.default.navigateTo({url:"./taskCC"})})},selectCharger:function(e,t){if(t.isEdit){this.setIssueStorage();var s=1===t.all_user,a={jobId:this.jobId,index:e,itemCharger:t,isAllUser:s};a=JSON.stringify(a),this.$preload("draftCharger",a),this.skip("N",function(){_wepy2.default.navigateTo({url:"./taskCharger"})})}},emitJsNode:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,s,a=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t={job_info:{job_name:this.issueName,creat_user_name:this.userInfo.nickname,issue_class:this.issueClass,issue_class_name:this.issueClassName,issue_sub_class:this.issueSubClass,issue_sub_class_name:this.issueSubClassName,task_info:"",desc_info:this.jobModule||{},dead_line:"",status:"N",class:5,time_out:this.timeoutValue,multi_attach_buff:[],task_numb:this.taskNumb}},t.job_info.desc_info=JSON.stringify(t.job_info.desc_info),e.prev=2,e.next=5,(0,_http.changeNodeFromJS)(t);case 5:if(s=e.sent,s.node_owners){e.next=8;break}return e.abrupt("return");case 8:s.node_owners.forEach(function(e){var t=e.owner;a.issueGraphList.forEach(function(){var s=_asyncToGenerator(regeneratorRuntime.mark(function s(r){var i;return regeneratorRuntime.wrap(function(s){for(;;)switch(s.prev=s.next){case 0:if(e.node_name!==r.node_name){s.next=8;break}return r.user_name=t.nickname,r.user_id=t.userid,r.chargerName=t.nickname,r.charger=t.userid,i={job_id:a.jobId,noder:[{node_id:r.node_id,node_name:r.node_name,next_id:r.next_id,user_id:t.userid,user_name:t.nickname,condidate_user_str:r.condidate_user_str,deuserid:r.deuserid}]},s.next=8,(0,_http.setUser)(i);case 8:case"end":return s.stop()}},s,a)}));return function(e){return s.apply(this,arguments)}}())}),this.$apply(),e.next=15;break;case 12:e.prev=12,e.t0=e.catch(2),wxApis.logMethod("log","changeNodeFromJS = "+JSON.stringify(e.t0),_wepy2.default.$instance.globalData.logInfo);case 15:case"end":return e.stop()}},e,this,[[2,12]])}));return e}()},a.events={getFlag:function(e){this.flag=e},parentBackFn:function(){_wepy2.default.navigateBack()}},r=s,_possibleConstructorReturn(a,r)}return _inherits(t,e),_createClass(t,[{key:"getJobInfo",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,s,a,r=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t={job_id:this.jobId},e.prev=1,e.next=4,(0,_http.queryJobInfo)(t);case 4:s=e.sent,s&&0===s.status&&(a=s.info,this.issueModelInfo=a||{},this.issueClass=a.issue_class,this.issueSubClass=a.issue_sub_class,this.issueClass=a.issue_class,this.issueClassName=a.issue_class_name,this.issueSubClassName=a.issue_sub_class_name,this.issueName=a.job_name,this.taskNumb=a.task_numb,this.timeoutValue=a.time_out,this.timeoutIndex=this.timeout.findIndex(function(e){return e===r.timeoutValue}),this.issueClassIndex=this.issueClassList.findIndex(function(e){return e.issue_class===r.issueClass}),this.issueModelInfo.created_at=_utils2.default.formatDateTime(this.issueModelInfo.created_at),this.issueModelInfo.ccList=[],this.loadUrl=this.$parent.globalData.baseUrl+"cloudproject/v1/query/file",this.issueModelInfo.relateiconpath||(this.issueModelInfo.relateiconpath="../../assets/images/task/default_photo.png"),a.desc_info&&(this.jobModule=JSON.parse(a.desc_info),this.jobModule.forEach(function(e,t){if("1"===e.isShow){if("4"!==e.modeltype&&"3"!==e.modeltype||(e.multi_attach_buff=e.value&&JSON.parse(e.value)||[],e.attachfileArr=e.value&&JSON.parse(e.value)||[],e.fileNameArr=[],e.imgUrlArr=[],e.multi_attach_buff.length>0&&e.multi_attach_buff.forEach(function(t){if(t){var s=r.loadUrl+"?sourceid="+t.source_id+"&loginSession="+r.userInfo.loginsession+"&requserid="+r.userInfo.userid;if(e.imgUrlArr.push((0,_formatfile.appendCookieToUrl)(s)),e.fileNameArr.push(t.file_name),t.file_name&&t.file_name.indexOf(".")>0){var a=t.file_name.split(".")[t.file_name.split(".").length-1].toLowerCase();"jpg"===a||"jpeg"===a||"png"===a?(t.downloadUrl=(0,_formatfile.appendCookieToUrl)(s),t.isImg=!0):(t.downloadUrl=s,t.isImg=!1)}}})),"5"===e.modeltype&&e.enumList.forEach(function(t,s){e.selectedIndex=0,t===e.value&&(e.selectedIndex=s)}),"6"===e.modeltype){e.value||(e.value={});for(var s in e.value)!0===e.value[s]&&e.valueList.push(e.multiSelectList[parseInt(s)])}if("8"===e.modeltype)if(e.tbodyArray.length>0)e.tbodyArray.forEach(function(e){e.forEach(function(e){if(e.value=e.content,"date"===e.columnsType&&(e.startDate="1971-01-01",e.endDate="2100-12-31"),"datetime"===e.columnsType){var t=e.content;t&&"请选择"!==t||(t=new Date),e.multiIndex=_utils2.default.handleTimePicker(t).multiIndex.slice(0,5),e.multiArray=_utils2.default.handleTimePicker(t).multiArray.slice(0,5)}if("select"===e.columnsType&&e.selectList.length>0&&(e.content||(e.value="",e.selectedIndex=0,e.selectedOption=""),e.selectList.forEach(function(t,s){t===e.selectedOption&&(e.selectedIndex=s,e.content=t,e.value=t)})),"file"===e.columnsType){var s="object"===_typeof(e.fileInfo);e.multi_attach_buff=s?[e.fileInfo]:[],e.attachfileArr=s?[e.fileInfo]:[],e.fileNameArr=[],e.imgUrlArr=[],e.multi_attach_buff.length>0&&e.multi_attach_buff.forEach(function(t){if(t){var s=r.loadUrl+"?sourceid="+t.source_id+"&loginSession="+r.userInfo.loginsession+"&requserid="+r.userInfo.userid;if(e.imgUrlArr.push((0,_formatfile.appendCookieToUrl)(s)),e.fileNameArr.push(t.file_name),t.file_name&&t.file_name.indexOf(".")>0){var a=t.file_name.split(".")[t.file_name.split(".").length-1].toLowerCase();"jpg"===a||"jpeg"===a||"png"===a?(t.downloadUrl=(0,_formatfile.appendCookieToUrl)(s),t.isImg=!0):(t.downloadUrl=s,t.isImg=!1)}}})}})});else{var a=[];e.tableObj.columns.forEach(function(e){var t={columnsName:e.columnsName,rowsName:"",columnsType:e.columnsType,content:"",columnsRequired:e.columnsRequired||""};if("date"===t.columnsType&&(t.content||(t.content="请选择"),t.value=t.content,t.startDate="1971-01-01",t.endDate="2100-12-31"),"datetime"===t.columnsType){t.content||(t.content="请选择"),t.value=t.content;var s=t.content;s&&"请选择"!==s||(s=new Date),t.multiIndex=_utils2.default.handleTimePicker(s).multiIndex.slice(0,5),t.multiArray=_utils2.default.handleTimePicker(s).multiArray.slice(0,5)}"select"===t.columnsType&&e.selectList.length>0&&(t.value=t.selectedOption,t.selectList=e.selectList,t.selectedIndex=t.selectList.findIndex(function(e){return t.selectedOption===e})||0),"file"===t.columnsType&&(t.fileInfo={},t.fileNameArr=[],t.attachfileArr=[],t.multi_attach_buff=[],t.imgUrlArr=[]),a.push(t)}),e.tbodyArray.push(a)}if("9"===e.modeltype&&"1"===e.dateForm&&(e.startDate="1971-01-01",e.endDate="2100-12-31"),"9"===e.modeltype&&"2"===e.dateForm){var i=e.value;i&&"请选择"!==i||(i=new Date),e.multiIndex=_utils2.default.handleTimePicker(i).multiIndex.slice(0,5),e.multiArray=_utils2.default.handleTimePicker(i).multiArray.slice(0,5),r.$apply()}}}),a.role_list.length>0&&(this.issueModelInfo.role_list=a.role_list,this.issueModelInfo.role_list.forEach(function(e){if("PM"===e.role_name&&(e.assignPM=e.user_id,e.assignPMName=e.nickname),"OP"===e.role_name&&(e.assignOP=e.user_id,e.assignOPName=e.nickname),"CC"===e.role_name&&e.nickname){var t=r.$parent.globalData.allUsers;if(Array.isArray(t)&&t.length>0)for(var s=0;s<t.length;s++)if(e.user_id===t[s].userid){r.issueModelInfo.ccList.push({user_id:e.user_id,nickname:e.nickname});break}}"CCG"===e.role_name&&r.issueModelInfo.ccList.push({group_id:e.group_id,group_name:e.group_name})}))),this.$apply(),this.getUserList()),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(1),wxApis.logMethod("log","queryJobInfo = "+JSON.stringify(e.t0),_wepy2.default.$instance.globalData.logInfo);case 11:case"end":return e.stop()}},e,this,[[1,8]])}));return e}()},{key:"getUserByTag",value:function(){function e(e,s){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t,s){var a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,(0,_http.queryUserByTag)(t);case 3:a=e.sent,s&&s(a),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),wxApis.logMethod("log","queryUserByTag = "+JSON.stringify(e.t0),_wepy2.default.$instance.globalData.logInfo);case 10:case"end":return e.stop()}},e,this,[[0,7]])}));return e}()},{key:"getByUserId",value:function(){function e(e,s){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t,s){var a,r,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:a=[],e.prev=1,r=0;case 3:if(!(r<t.length)){e.next=11;break}return e.next=6,(0,_http.queryByUserId)({userid:t[r].user_id});case 6:i=e.sent,i&&0===i.status&&a.push(i.userinfo.accountinfo);case 8:r++,e.next=3;break;case 11:e.next=16;break;case 13:e.prev=13,e.t0=e.catch(1),wxApis.logMethod("log","queryUserByTag = "+JSON.stringify(e.t0),_wepy2.default.$instance.globalData.logInfo);case 16:s&&s(a);case 17:case"end":return e.stop()}},e,this,[[1,13]])}));return e}()},{key:"getByUserRole",value:function(){function e(e,s){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t,s){var a,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a={rolename:t},e.prev=1,e.next=4,(0,_http.queryUserByrole)(a);case 4:r=e.sent,r&&0===r.status&&s&&s(r),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(1),wxApis.logMethod("log","queryUserByrole = "+JSON.stringify(e.t0),_wepy2.default.$instance.globalData.logInfo);case 11:case"end":return e.stop()}},e,this,[[1,8]])}));return e}()},{key:"getUserList",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t={job_id:this.jobId},e.prev=1,e.next=4,(0,_http.queryUserList)(t);case 4:s=e.sent,s&&0===s.status&&(this.issueGraphList=s.noder||[],this.issueGraphList.length>0&&this.issueGraphList.forEach(function(e,t){e.isEdit=!0,e.nodeId=e.node_id,e.condidate_user_str&&(e.condidate_user=JSON.parse(e.condidate_user_str));var s=e.deuserid,a=e.condidate_user,r=s&&"#CREAT"!==s&&!/^['@'|'#'|'$'|]/.test(s)&&0===a.length||!s&&1===a.length&&!/^['@'|'#'|'$'|]/.test(a[0])&&!a[0].user_id||"#CREAT"===s&&0===a.length||!s&&0===a.length;r&&2===e.all_user&&(e.isEdit=!1),s||0!==a.length||2!==e.all_user||e.user_id||(e.isEdit=!0),r&&!e.user_id&&(e.isEdit=!0,e.all_user=1)}),this.$apply()),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(1),wxApis.logMethod("log","queryUserList = "+JSON.stringify(e.t0),_wepy2.default.$instance.globalData.logInfo);case 11:case"end":return e.stop()}},e,this,[[1,8]])}));return e}()},{key:"getOPList",value:function(){var e=this;this.getByUserRole("OP",function(t){t.userlist&&t.userlist.OP&&(e.OPList=t.userlist.OP,e.OPList=e.OPList.filter(function(e){return""!==e.userid}))})}},{key:"getPMList",value:function(){var e=this;this.getByUserRole("PM",function(t){t.userlist&&t.userlist.PM&&(e.PMList=t.userlist.PM,e.PMList=e.PMList.filter(function(e){return""!==e.userid}))})}},{key:"skip",value:function(){function e(e,s){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t,s){var a,r,i,n,o,u,l,c,f,d,p,h,m,_,b,g,y,v,k=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.issueModelInfo.issue_class){e.next=2;break}return e.abrupt("return",this.taskCreatTip("请输入任务分类"));case 2:if(this.issueModelInfo.issue_sub_class){e.next=4;break}return e.abrupt("return",this.taskCreatTip("请选择任务"));case 4:if(this.issueName){e.next=6;break}return e.abrupt("return",this.taskCreatTip("请输入任务名称"));case 6:if(!_utils2.default.emojiReg(this.issueName)){e.next=8;break}return e.abrupt("return",this.taskCreatTip("任务名称不能包含表情符号"));case 8:if(!(!this.issueModelInfo.time_out>0)){e.next=10;break}return e.abrupt("return",this.taskCreatTip("请选择超时时间"));case 10:if("N"!==t){e.next=15;break}for(a=0;a<this.issueGraphList.length;a++)r=this.issueGraphList[a],r.user_id||(r.user_id="");this.jobModule.length>0&&this.jobModule.forEach(function(e){if("1"===e.isShow){if(("2"===e.modeltype||"1"===e.modeltype||"10"===e.modeltype)&&e.value&&_utils2.default.emojiReg(e.value))return k.taskCreatTip(e.modelname+"不能包含表情符号");"3"!==e.modeltype&&"4"!==e.modeltype||(0===e.attachfileArr.length&&(e.attachfileArr=[],e.fileNameArr=[],e.multi_attach_buff=[],e.imgUrlArr=[]),e.value=JSON.stringify(e.attachfileArr))}}),e.next=85;break;case 15:i=0;case 16:if(!(i<this.issueGraphList.length)){e.next=24;break}if(n=this.issueGraphList[i],n.user_name){e.next=21;break}return n.user_id="",e.abrupt("return",this.taskCreatTip("请补全负责人"));case 21:i++,e.next=16;break;case 24:o=0;case 25:if(!(o<this.jobModule.length)){e.next=85;break}if(u=this.jobModule[o],"1"!==u.isShow){e.next=82;break}if("1"!==u.modeltype&&"2"!==u.modeltype&&"5"!==u.modeltype){e.next=40;break}if("1"!==u.isRequired){e.next=39;break}if(u.value&&"请选择"!==u.value&&"请输入"!==u.value){e.next=35;break}return l="5"===u.modeltype?"请选择":"请输入",e.abrupt("return",this.taskCreatTip(l+u.modelname));case 35:if(!u.value||!_utils2.default.emojiReg(u.value)){e.next=37;break}return e.abrupt("return",this.taskCreatTip(u.modelname+"不能包含表情符号"));case 37:e.next=40;break;case 39:"0"===u.isRequired&&(u.value&&"请选择"!==u.value&&"请输入"!==u.value||(u.value=""));case 40:if("3"!==u.modeltype&&"4"!==u.modeltype){e.next=51;break}if(0!==u.attachfileArr.length){e.next=50;break}if("1"!==u.isRequired){e.next=46;break}return e.abrupt("return",this.taskCreatTip("请上传"+u.modelname));case 46:u.attachfileArr=[],u.fileNameArr=[],u.multi_attach_buff=[],u.imgUrlArr=[];case 50:u.value=JSON.stringify(u.attachfileArr);case 51:if("6"!==u.modeltype){e.next=54;break}if("1"!==u.isRequired||0!==u.valueList.length){e.next=54;break}return e.abrupt("return",this.taskCreatTip("请选择"+u.modelname));case 54:if("9"!==u.modeltype){e.next=57;break}if("1"!==u.isRequired||u.value&&"请选择"!==u.value&&"请输入"!==u.value){e.next=57;break}return e.abrupt("return",this.taskCreatTip("请选择"+u.modelname));case 57:if("10"!==u.modeltype){e.next=60;break}if("1"!==u.isRequired||u.value&&"请选择"!==u.value&&"请输入"!==u.value){e.next=60;break}return e.abrupt("return",this.taskCreatTip("请输入"+u.modelname));case 60:if("8"!==u.modeltype){e.next=82;break}if(c=u.tbodyArray,f=!1,!(c&&c.length>0)){e.next=82;break}d=0;case 65:if(!(d<c.length)){e.next=80;break}p=c[d],h=0;case 68:if(!(h<p.length)){e.next=77;break}if(m=p[h],f||(f=m.content&&"请选择"!==m.content||m.selectedOption||0===m.selectedOption),!(_="1"===m.columnsRequired&&((!m.content||"请选择"===m.content)&&"select"!==m.columnsType||"select"===m.columnsType&&!m.selectedOption))){e.next=74;break}return e.abrupt("return",this.taskCreatTip(u.modelname+"：表格里有必填项未填，请检查"));case 74:h++,e.next=68;break;case 77:d++,e.next=65;break;case 80:if("1"!==u.isRequired||f){e.next=82;break}return e.abrupt("return",this.taskCreatTip(u.modelname+"：表格里有必填项未填，请检查"));case 82:o++,e.next=25;break;case 85:return b=[],this.issueModelInfo.ccList.forEach(function(e){e.user_id?b.push({role_name:"CC",user_id:e.userid}):e.group_id&&b.push({role_name:"CCG",group_id:e.group_id})}),g={jobinfo:{job_id:this.jobId,job_name:this.issueName,creat_user_name:this.userInfo.nickname,issue_class:this.issueClass,issue_class_name:this.issueClassName,issue_sub_class:this.issueSubClass,issue_sub_class_name:this.issueSubClassName,task_info:"",desc_info:this.jobModule||[],dead_line:"",status:t,class:5,time_out:this.timeout[this.timeoutValue],multi_attach_buff:[],task_numb:this.taskNumb}},g.jobinfo.desc_info.forEach(function(e){if("9"===e.modeltype&&("请选择"===e.value&&(e.value=""),"2"===e.dateForm&&(e.multiIndex=[],e.multiArray=[])),"8"===e.modeltype)for(var t=0;t<e.tbodyArray.length;t++)for(var s=e.tbodyArray[t],a=0;a<s.length;a++){var r=s[a];if("请选择"===r.content&&(r.content=""),("text"===r.columnsType||"urllink"===r.columnsType||"textarea"===r.columnsType)&&r.content&&_utils2.default.emojiReg(r.content))return k.taskCreatTip(r.columnsName+"不能包含表情符号");"datetime"===r.columnsType&&(r.multiTableIndex=[],r.multiTableArray=[]),"file"===r.columnsType&&(r.fileInfo&&r.fileInfo.source_id?r.value=JSON.stringify([r.fileInfo]):r.value="")}}),g.jobinfo.desc_info=JSON.stringify(g.jobinfo.desc_info),e.prev=90,e.next=93,(0,_http.updateJob)(g);case 93:if(y=e.sent,"N"!==t){e.next=98;break}y&&0===y.status&&(this.$preload("jobId",y.jobid),s&&s()),e.next=108;break;case 98:return v={jobinfo:{job_id:this.jobId,status:t}},e.prev=99,e.next=102,(0,_http.updateToCreateJob)(v);case 102:s&&s(),e.next=108;break;case 105:e.prev=105,e.t0=e.catch(99),wxApis.logMethod("log","updateToCreateJob = "+JSON.stringify(e.t0),_wepy2.default.$instance.globalData.logInfo);case 108:e.next=113;break;case 110:e.prev=110,e.t1=e.catch(90),wxApis.logMethod("log","updateJob = "+JSON.stringify(e.t1),_wepy2.default.$instance.globalData.logInfo);case 113:case"end":return e.stop()}},e,this,[[90,110],[99,105]])}));return e}()},{key:"addImages",value:function(){function e(e,s,a){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t,s,a){var r,i,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:r=[],e.prev=1,i=0;case 3:if(!(i<t.length)){e.next=12;break}return e.next=6,(0,_http.uploadFile)({filePath:t[i],formData:{file:s}});case 6:n=e.sent,n=JSON.parse(n),n.sourceid&&r.push({file_name:t[i],source_id:n.sourceid});case 9:i++,e.next=3;break;case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(1),wxApis.logMethod("log","uploadFile = "+JSON.stringify(e.t0),_wepy2.default.$instance.globalData.logInfo);case 17:a&&a(r);case 18:case"end":return e.stop()}},e,this,[[1,14]])}));return e}()},{key:"setIssueStorage",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:this.$parent.globalData.issueInfo={issueClass:this.issueClass,issueSubClass:this.issueSubClass};case 1:case"end":return e.stop()}},e,this)}));return e}()},{key:"getAllUser",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,s=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,_http.queryUserByrole)();case 2:t=e.sent,t&&0===t.status&&function(){var e=[],a=t.userlist;for(var r in a)a[r].forEach(function(t){e.push(t)});e=s.handleRepeat(e,"userid"),s.$parent.globalData.allUsers=e}();case 4:case"end":return e.stop()}},e,this)}));return e}()},{key:"formatDateData",value:function(e,t){if(!year||!day&&0!==day){var s=_utils2.default.formatDateTime(new Date);s=s.split(/[-:\s]/),year=parseInt(s[0]),month||(month=s[1]),day=parseInt(s[2])-1}switch(1===e&&30===day&&(t+1===7||t-1==7||t+1===8||t-1==8)&&("07"===month||"08"===month&&8!==t)||(day=30===day?day-1:day),e){case 0:year=t+1971;break;case 1:month=_utils2.default.addZeroToTime(t+1);break;case 2:day=t}}},{key:"onLoad",value:function(e,t){t=t||{},this.preload=t.preload||{},this.getPMList(),this.getOPList();var s=this.$parent.globalData.windowWH||{},a=this.$parent.globalData.allUsers;this.height=s.height,this.height=this.height||667,(!a||Array.isArray(a)&&0===a.length)&&this.getAllUser()}},{key:"onShow",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isEdited=!1,this.userInfo=this.$parent.globalData.userInfo,this.baseUrl=this.$parent.globalData.baseUrl,this.jobId=this.preload.jobId||"",!this.flag){e.next=8;break}return e.abrupt("return",this.flag=!1);case 8:this.getJobInfo();case 9:case"end":return e.stop()}},e,this)}));return e}()},{key:"onHide",value:function(){}}]),t}(_wepy2.default.page);Page(require("./../../npm/wepy/lib/wepy.js").default.$createPage(taskDraft,"task/pages/taskDraft"));