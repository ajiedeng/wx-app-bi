"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,a=Array(t.length);e<t.length;e++)a[e]=t[e];return a}return Array.from(t)}function _defineProperty(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}function _asyncToGenerator(t){return function(){var e=t.apply(this,arguments);return new Promise(function(t,a){function r(i,n){try{var s=e[i](n),o=s.value}catch(t){return void a(t)}if(!s.done)return Promise.resolve(o).then(function(t){r("next",t)},function(t){r("throw",t)});t(o)}return r("next")})}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var r=e[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,a,r){return a&&t(e.prototype,a),r&&t(e,r),e}}(),_wepy=require("./../../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_topBar=require("./../../components/topBar.js"),_topBar2=_interopRequireDefault(_topBar),_commonApi=require("./../../mixins/commonApi.js"),_commonApi2=_interopRequireDefault(_commonApi),_toast=require("./../../mixins/toast.js"),_toast2=_interopRequireDefault(_toast),_http=require("./../../utils/http.js"),_utils=require("./../../utils/utils.js"),_utils2=_interopRequireDefault(_utils),wxApis=require("./../../utils/wxApi.js"),_require=require("./../../utils/loginInfo.js"),getUserInfo=_require.getUserInfo,taskManage=function(t){function e(){var t,a,r,i;_classCallCheck(this,e);for(var n=arguments.length,s=Array(n),o=0;o<n;o++)s[o]=arguments[o];return a=r=_possibleConstructorReturn(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this].concat(s))),r.data={tabList:[{tabUrl:"list",tabName:"待处理",status:[]},{tabUrl:"list",tabName:"我创建的",status:[]},{tabUrl:"joinedlist",tabName:"与我相关",status:[]},{tabUrl:"cclist",tabName:"抄送给我",status:[]},{tabUrl:"list",tabName:"草稿箱",status:["N"]}],userInfo:{},currentTabUrl:"list",status:[],isScroll:!0,windowWidth:0,jobList:[],allList:[],userImage:"",height:0,itemHeight:0,delBtnWidth:75,version:"",activeIndex:0,toproc_num:0,cc_num:0,top:0,width:0,loadMoreShow:!0,tabsInfo:"",page:{pageid:0,pagesize:20,loadPage:0,loadNum:20},issueType:"relate_user_id"},r.$repeat={},r.$props={topBar:{"xmlns:v-on":"",bindparentBackFn:"parentBackFn"}},r.$events={topBar:{"v-on:topNavFn":"getScrollHeight"}},r.components={topBar:_topBar2.default},r.mixins=[_commonApi2.default,_toast2.default],r.events={parentBackFn:function(){_wepy2.default.navigateBack()}},r.methods={getScrollHeight:function(t,e){var a=this,r=this.$parent.globalData.windowWH||{},i=r.width,n=r.height;n=n||667,this.windowWidth=i,this.width=i+parseInt(120*i/375);var s=wx.createSelectorQuery();s.select("#tabsHead").boundingClientRect(),s.exec(function(e){e[0]&&null!==e[0]&&e[0].height&&(a.height=n-e[0].height-t-8,a.$apply())})},changeTab:function(t,e){this.tabsInfo="",this.activeIndex=t,this.currentTabUrl=e.tabUrl,this.status=e.status,this.page.loadPage=0,this.page.pageid=0,this.jobList=[],this.loadMoreShow=!0,this.taskCount(),this.getPendingList(this.activeIndex,this.currentTabUrl,e.status)},toTaskDetail:function(){function t(t){return e.apply(this,arguments)}var e=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var a;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.$preload("jobId",e),4!==this.activeIndex){t.next=5;break}_wepy2.default.redirectTo({url:"./taskDraft"}),t.next=17;break;case 5:if(3!==this.activeIndex){t.next=16;break}return t.prev=6,t.next=9,(0,_http.queryJobRead)({job_id:e,type:2});case 9:a=t.sent,0===a.data&&(this.jobList.find(function(t){return t.job_id===e}).sight=2,this.$apply()),t.next=16;break;case 13:t.prev=13,t.t0=t.catch(6),wxApis.logMethod("log","queryJobRead = "+JSON.stringify(t.t0),!1);case 16:_wepy2.default.navigateTo({url:"./taskDetail"});case 17:case"end":return t.stop()}},t,this,[[6,13]])}));return t}(),toCreateTask:function(){_wepy2.default.redirectTo({url:"./taskCreate"})},loadMore:function(){if(this.page.loadPage*this.page.loadNum>=this.allList.length)return this.loadMoreShow=!1;this.loadMoreShow&&(this.page.loadPage++,this.page.pageid++),this.allList&&this.getPendingList(this.activeIndex,this.currentTabUrl,this.status)},touchM:function(t,e){if(4===this.activeIndex){var a=e.touches[0].clientX-this.startX;a<0&&a<=-20?(this.showDeleteButton(t,e),this.isScroll=!1):this.isScroll=!0}},touchS:function(t,e){4===this.activeIndex&&(this.startX=e.touches[0].clientX)},touchE:function(t,e){4===this.activeIndex&&(e.changedTouches[0].clientX<this.startX&&e.changedTouches[0].clientX-this.startX<=-30?(this.isScroll=!1,this.showDeleteButton(t,e)):e.changedTouches[0].clientX>this.startX&&e.changedTouches[0].clientX-this.startX<30?(this.isScroll=!1,this.showDeleteButton(t,e)):(this.isScroll=!0,this.hideDeleteButton(t,e)))},deleteJob:function(t,e){var a=this;this.showCommonModal({content:"请确认是否删除？"},_asyncToGenerator(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,(0,_http.deleteDraftJob)({job_id:e.job_id});case 3:t.next=8;break;case 5:t.prev=5,t.t0=t.catch(0),wxApis.logMethod("log","deleteDraftJob = "+JSON.stringify(t.t0),!1);case 8:a.getPendingList(a.activeIndex,a.currentTabUrl,a.status);case 9:case"end":return t.stop()}},t,a,[[0,5]])})))}},i=a,_possibleConstructorReturn(r,i)}return _inherits(e,t),_createClass(e,[{key:"taskCount",value:function(){function t(){return e.apply(this,arguments)}var e=_asyncToGenerator(regeneratorRuntime.mark(function t(){var e;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,(0,_http.count)();case 3:e=t.sent,e&&0===e.status&&(this.toproc_num=e.toproc_num,this.cc_num=e.cc_num,this.$apply()),t.next=10;break;case 7:t.prev=7,t.t0=t.catch(0),wxApis.logMethod("log","count = "+JSON.stringify(t.t0),!1);case 10:case"end":return t.stop()}},t,this,[[0,7]])}));return t}()},{key:"classTransform",value:function(t){if(!t)return"";switch(t=t.toString()){case"0":return"relate_user_id";case"1":case"4":return"creat_user_id";default:return""}}},{key:"getPendingList",value:function(){function t(t,a,r){return e.apply(this,arguments)}var e=_asyncToGenerator(regeneratorRuntime.mark(function t(e,a,r){var i,n,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return a=a||this.currentTabUrl,this.loadMoreShow=!1,e=e||"0",this.issueType=this.classTransform(e),s=this.issueType?_defineProperty({pageid:this.page.pageid,pagesize:s.pagesize||this.page.pagesize,status:r,job_name:""},this.issueType,this.userInfo.userid):{pageid:this.page.pageid,pagesize:s.pagesize||this.page.pagesize},t.prev=5,t.next=8,(0,_http.queryPendingList)(s,a);case 8:i=t.sent,i&&0===i.status?(n=i.list||[],n=n.map(function(t){return t.xmove=0,t.created_at=_utils2.default.formatDateTime(t.created_at),t.txtStyle=0,t}),this.page.loadPage>=1?(this.jobList=this.jobList.slice(0,this.page.loadNum*this.page.loadPage),this.jobList=[].concat(_toConsumableArray(this.jobList),_toConsumableArray(n))):this.jobList=n,this.jobList=this.handleRepeat(this.jobList,"job_id"),this.page.loadPage*this.page.loadNum>=i.totalnum?this.loadMoreShow=!1:this.loadMoreShow=!0,this.allList=this.jobList,this.$apply()):wxApis.logMethod("log","queryPendingList = "+JSON.stringify(i),!1),t.next=15;break;case 12:t.prev=12,t.t0=t.catch(5),wxApis.logMethod("log","queryPendingList = "+JSON.stringify(t.t0),!1);case 15:case"end":return t.stop()}},t,this,[[5,12]])}));return t}()},{key:"getAllUser",value:function(){function t(){return e.apply(this,arguments)}var e=_asyncToGenerator(regeneratorRuntime.mark(function t(){var e,a=this;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,_http.queryUserByrole)();case 2:e=t.sent,e&&0===e.status&&function(){var t=[],r=e.userlist;for(var i in r)r[i].forEach(function(e){t.push(e)});t=a.handleRepeat(t,"userid"),a.$parent.globalData.allUsers=t}();case 4:case"end":return t.stop()}},t,this)}));return t}()},{key:"showDeleteButton",value:function(t,e){var a=this.windowWidth,r=parseInt(120*a/375/2);a&&(a<=667?this.setXmove(t,-65):a>667&&a<896?this.setXmove(t,-r):a>=896&&this.setXmove(t,-r))}},{key:"hideDeleteButton",value:function(t,e){this.setXmove(t,0)}},{key:"setXmove",value:function(t,e){var a=this.jobList;a.forEach(function(e,a){a!==t&&(e.xmove=0)}),a[t].xmove=e}},{key:"onLoad",value:function(){this.$parent.globalData.isLogin=!0,this.$parent.globalData.userInfo=getUserInfo(),console.log("onLoad",getUserInfo()),this.version=this.$parent.globalData.version,this.userInfo=this.$parent.globalData.userInfo,this.tabsInfo=this.$parent.globalData.tabsInfo||{};var t=this.tabsInfo;t&&t.tabs&&t.tabs.currentTabUrl&&(this.activeIndex=t.tabs.activeIndex,this.currentTabUrl=t.tabs.currentTabUrl,this.status=t.tabs.status,this.page=t.page,this.page.pageid=0),this.taskCount(),this.getPendingList(this.activeIndex,this.currentTabUrl,this.status),this.getAllUser()}},{key:"onShow",value:function(){var t=this.getCurrentPages();t.length>=4?_wepy2.default.navigateBack({delta:2}):2!==t.length||this.tabsInfo.tabs||(this.taskCount(),this.getPendingList(this.activeIndex,this.currentTabUrl,this.status))}},{key:"onHide",value:function(){this.initDatas()}},{key:"onUnload",value:function(){this.initDatas()}},{key:"initDatas",value:function(){var t={tabs:{activeIndex:this.activeIndex,currentTabUrl:this.currentTabUrl,status:this.status},page:this.page,top:this.top};this.removeStorage(),this.$parent.globalData.tabsInfo=t}}]),e}(_wepy2.default.page);Page(require("./../../npm/wepy/lib/wepy.js").default.$createPage(taskManage,"task/pages/taskManage"));